<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³åŠŸèƒ½è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        button {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: #0066ff;
            color: white;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            margin-top: 20px;
        }
        .log-line {
            margin-bottom: 4px;
        }
        .log-error { color: #f48771; }
        .log-success { color: #89d185; }
        .log-warning { color: #e5c07b; }
        .log-info { color: #61afef; }
        .status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
        }
        .status-testing {
            background: #e3f2fd;
            color: #1976d2;
        }
        .status-success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status-failed {
            background: #ffebee;
            color: #c62828;
        }
        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }
        .note strong {
            display: block;
            margin-bottom: 8px;
            color: #856404;
        }
        .note ul {
            margin: 8px 0;
            padding-left: 20px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ è¯­éŸ³åŠŸèƒ½è¯Šæ–­å·¥å…·</h1>
        <p class="subtitle">ç”¨äºæµ‹è¯•Tauriç¯å¢ƒä¸­çš„Web Speech APIå…¼å®¹æ€§</p>

        <div id="status"></div>

        <button class="btn-primary" onclick="testWebSpeechAPI()">
            æµ‹è¯• Web Speech APIï¼ˆè¯­éŸ³è¯†åˆ«ï¼‰
        </button>

        <button class="btn-secondary" onclick="testMediaRecorder()">
            æµ‹è¯• MediaRecorderï¼ˆå½•éŸ³åŠŸèƒ½ï¼‰
        </button>

        <button class="btn-secondary" onclick="clearLog()">
            æ¸…ç©ºæ—¥å¿—
        </button>

        <div id="log"></div>

        <div class="note">
            <strong>âš ï¸ é‡è¦è¯´æ˜ï¼š</strong>
            <ul>
                <li>å¦‚æœåº”ç”¨åœ¨æµ‹è¯•æ—¶<strong>å´©æºƒé€€å‡º</strong>ï¼Œè¯´æ˜å½“å‰ç¯å¢ƒä¸æ”¯æŒè¯¥API</li>
                <li>Web Speech APIéœ€è¦ç½‘ç»œè¿æ¥ï¼ˆä½¿ç”¨Googleäº‘æœåŠ¡ï¼‰</li>
                <li>è¯·åœ¨æµ‹è¯•å‰æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆCmd+Option+Iï¼‰æŸ¥çœ‹console</li>
                <li>å¦‚æœWeb Speech APIå¯¼è‡´å´©æºƒï¼Œå¯ä½¿ç”¨MediaRecorderä½œä¸ºæ›¿ä»£æ–¹æ¡ˆ</li>
            </ul>
        </div>
    </div>

    <script>
        let logs = [];
        let testStatus = 'idle';

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${message}`;
            logs.push({ message: logLine, type });

            const logDiv = document.getElementById('log');
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            line.textContent = logLine;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;

            console.log(message);
        }

        function setStatus(status) {
            testStatus = status;
            const statusDiv = document.getElementById('status');

            if (status === 'idle') {
                statusDiv.innerHTML = '';
                return;
            }

            const statusText = {
                testing: 'æµ‹è¯•ä¸­...',
                success: 'âœ… æµ‹è¯•æˆåŠŸ',
                failed: 'âŒ æµ‹è¯•å¤±è´¥'
            }[status];

            statusDiv.innerHTML = `<div class="status status-${status}">${statusText}</div>`;
        }

        function clearLog() {
            logs = [];
            document.getElementById('log').innerHTML = '';
            setStatus('idle');
        }

        async function testWebSpeechAPI() {
            clearLog();
            setStatus('testing');
            addLog('====================================', 'info');
            addLog('å¼€å§‹æµ‹è¯• Web Speech API', 'info');
            addLog('====================================', 'info');

            try {
                // æµ‹è¯•1
                addLog('æ­¥éª¤ 1/6: æ£€æŸ¥Web Speech APIæ˜¯å¦å­˜åœ¨...', 'info');
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                if (!SpeechRecognition) {
                    addLog('âŒ Web Speech API ä¸å­˜åœ¨', 'error');
                    setStatus('failed');
                    return;
                }
                addLog('âœ… Web Speech API å­˜åœ¨', 'success');

                // æµ‹è¯•2
                addLog('æ­¥éª¤ 2/6: æ£€æŸ¥MediaDevices API...', 'info');
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    addLog('âŒ MediaDevices API ä¸å¯ç”¨', 'error');
                    setStatus('failed');
                    return;
                }
                addLog('âœ… MediaDevices API å¯ç”¨', 'success');

                // æµ‹è¯•3
                addLog('æ­¥éª¤ 3/6: è¯·æ±‚éº¦å…‹é£æƒé™...', 'info');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    addLog('âœ… éº¦å…‹é£æƒé™å·²æˆäºˆ', 'success');
                    stream.getTracks().forEach(track => track.stop());
                } catch (error) {
                    addLog(`âŒ éº¦å…‹é£æƒé™å¤±è´¥: ${error.message}`, 'error');
                    setStatus('failed');
                    return;
                }

                // æµ‹è¯•4
                addLog('æ­¥éª¤ 4/6: åˆ›å»ºSpeechRecognitionå®ä¾‹...', 'info');
                let recognition;
                try {
                    recognition = new SpeechRecognition();
                    addLog('âœ… å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                } catch (error) {
                    addLog(`âŒ å®ä¾‹åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
                    setStatus('failed');
                    return;
                }

                // æµ‹è¯•5
                addLog('æ­¥éª¤ 5/6: é…ç½®recognition...', 'info');
                try {
                    recognition.lang = 'zh-CN';
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    addLog('âœ… é…ç½®æˆåŠŸ', 'success');
                } catch (error) {
                    addLog(`âŒ é…ç½®å¤±è´¥: ${error.message}`, 'error');
                    setStatus('failed');
                    return;
                }

                // æµ‹è¯•6 - æœ€å…³é”®çš„ä¸€æ­¥
                addLog('æ­¥éª¤ 6/6: å°è¯•å¯åŠ¨recognition...', 'warning');
                addLog('âš ï¸  å¦‚æœåº”ç”¨åœ¨æ­¤å´©æºƒï¼Œè¯´æ˜WKWebViewä¸æ”¯æŒWeb Speech API', 'warning');
                addLog('â³ ç­‰å¾…ä¸­... æœ€å¤š10ç§’', 'info');

                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        addLog('âŒ å¯åŠ¨è¶…æ—¶ï¼ˆ10ç§’ï¼‰', 'error');
                        try { recognition.abort(); } catch (e) {}
                        setStatus('failed');
                        reject(new Error('è¶…æ—¶'));
                    }, 10000);

                    recognition.onstart = () => {
                        clearTimeout(timeout);
                        addLog('âœ… recognition.onstart äº‹ä»¶è§¦å‘ï¼', 'success');
                        addLog('ğŸ‰ Web Speech API å®Œå…¨å¯ç”¨ï¼', 'success');
                        setTimeout(() => {
                            try { recognition.stop(); } catch (e) {}
                        }, 1000);
                    };

                    recognition.onend = () => {
                        addLog('âœ… recognition.onend äº‹ä»¶è§¦å‘', 'success');
                        addLog('====================================', 'info');
                        addLog('âœ… æµ‹è¯•å®Œæˆï¼šWeb Speech API å¯ç”¨', 'success');
                        addLog('====================================', 'info');
                        setStatus('success');
                        resolve();
                    };

                    recognition.onerror = (event) => {
                        clearTimeout(timeout);
                        addLog(`âŒ recognition.onerror: ${event.error}`, 'error');
                        setStatus('failed');
                        reject(new Error(event.error));
                    };

                    try {
                        recognition.start();
                        addLog('â³ start() è°ƒç”¨å®Œæˆï¼Œç­‰å¾…onstartäº‹ä»¶...', 'info');
                    } catch (error) {
                        clearTimeout(timeout);
                        addLog(`âŒ start() æŠ›å‡ºå¼‚å¸¸: ${error.message}`, 'error');
                        setStatus('failed');
                        reject(error);
                    }
                });
            } catch (error) {
                addLog(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addLog('====================================', 'info');
                addLog('ç»“è®ºï¼šWeb Speech API åœ¨å½“å‰ç¯å¢ƒä¸å¯ç”¨', 'error');
                addLog('====================================', 'info');
                setStatus('failed');
            }
        }

        async function testMediaRecorder() {
            clearLog();
            setStatus('testing');
            addLog('====================================', 'info');
            addLog('å¼€å§‹æµ‹è¯• MediaRecorder API', 'info');
            addLog('====================================', 'info');

            try {
                // æµ‹è¯•1
                addLog('æ­¥éª¤ 1/3: è¯·æ±‚éº¦å…‹é£æƒé™...', 'info');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                addLog('âœ… éº¦å…‹é£æƒé™å·²æˆäºˆ', 'success');

                // æµ‹è¯•2
                addLog('æ­¥éª¤ 2/3: æµ‹è¯•MediaRecorder API...', 'info');
                if (!window.MediaRecorder) {
                    addLog('âŒ MediaRecorder ä¸å¯ç”¨', 'error');
                    setStatus('failed');
                    return;
                }

                const recorder = new MediaRecorder(stream);
                addLog('âœ… MediaRecorder åˆ›å»ºæˆåŠŸ', 'success');

                recorder.ondataavailable = (e) => {
                    addLog(`âœ… å½•éŸ³æ•°æ®å¤§å°: ${e.data.size} bytes`, 'success');
                };

                recorder.onstart = () => {
                    addLog('âœ… å½•éŸ³å·²å¼€å§‹', 'success');
                };

                recorder.onstop = () => {
                    addLog('âœ… å½•éŸ³å·²åœæ­¢', 'success');
                    stream.getTracks().forEach(track => track.stop());
                    addLog('====================================', 'info');
                    addLog('âœ… æµ‹è¯•å®Œæˆï¼šMediaRecorder å¯ç”¨ï¼', 'success');
                    addLog('ğŸ’¡ å¯ä»¥ç”¨å®ƒå®ç°å½•éŸ³åŠŸèƒ½ï¼Œç„¶åè°ƒç”¨äº‘ç«¯è¯­éŸ³è¯†åˆ«æœåŠ¡', 'info');
                    addLog('====================================', 'info');
                    setStatus('success');
                };

                // æµ‹è¯•3
                addLog('æ­¥éª¤ 3/3: å¼€å§‹å½•éŸ³æµ‹è¯•...', 'info');
                recorder.start();
                addLog('â³ å½•éŸ³ä¸­... 2ç§’åè‡ªåŠ¨åœæ­¢', 'info');

                setTimeout(() => {
                    recorder.stop();
                }, 2000);
            } catch (error) {
                addLog(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addLog('====================================', 'info');
                addLog('ç»“è®ºï¼šMediaRecorder åœ¨å½“å‰ç¯å¢ƒä¸å¯ç”¨', 'error');
                addLog('====================================', 'info');
                setStatus('failed');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„è¯´æ˜
        window.addEventListener('load', () => {
            addLog('è¯­éŸ³åŠŸèƒ½è¯Šæ–­å·¥å…·å·²å°±ç»ª', 'info');
            addLog('è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
            addLog('', 'info');
        });
    </script>
</body>
</html>

